(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[625],{6221:function(e,t,s){Promise.resolve().then(s.bind(s,1134))},1134:function(e,t,s){"use strict";s.r(t),s.d(t,{default:function(){return C}});var a=s(539),l=s(9856);let n=e=>e.replace(/([a-z0-9])([A-Z])/g,"$1-$2").toLowerCase(),r=e=>e.replace(/^([A-Z])|[\s-_]+(\w)/g,(e,t,s)=>s?s.toUpperCase():t.toLowerCase()),i=e=>{let t=r(e);return t.charAt(0).toUpperCase()+t.slice(1)},o=function(){for(var e=arguments.length,t=Array(e),s=0;s<e;s++)t[s]=arguments[s];return t.filter((e,t,s)=>!!e&&""!==e.trim()&&s.indexOf(e)===t).join(" ").trim()},c=e=>{for(let t in e)if(t.startsWith("aria-")||"role"===t||"title"===t)return!0};var d={xmlns:"http://www.w3.org/2000/svg",width:24,height:24,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:2,strokeLinecap:"round",strokeLinejoin:"round"};let x=(0,l.forwardRef)((e,t)=>{let{color:s="currentColor",size:a=24,strokeWidth:n=2,absoluteStrokeWidth:r,className:i="",children:x,iconNode:m,...h}=e;return(0,l.createElement)("svg",{ref:t,...d,width:a,height:a,stroke:s,strokeWidth:r?24*Number(n)/Number(a):n,className:o("lucide",i),...!x&&!c(h)&&{"aria-hidden":"true"},...h},[...m.map(e=>{let[t,s]=e;return(0,l.createElement)(t,s)}),...Array.isArray(x)?x:[x]])}),m=(e,t)=>{let s=(0,l.forwardRef)((s,a)=>{let{className:r,...c}=s;return(0,l.createElement)(x,{ref:a,iconNode:t,className:o("lucide-".concat(n(i(e))),"lucide-".concat(e),r),...c})});return s.displayName=i(e),s},h=m("arrow-left",[["path",{d:"m12 19-7-7 7-7",key:"1l729n"}],["path",{d:"M19 12H5",key:"x3x0zl"}]]),u=m("settings",[["path",{d:"M9.671 4.136a2.34 2.34 0 0 1 4.659 0 2.34 2.34 0 0 0 3.319 1.915 2.34 2.34 0 0 1 2.33 4.033 2.34 2.34 0 0 0 0 3.831 2.34 2.34 0 0 1-2.33 4.033 2.34 2.34 0 0 0-3.319 1.915 2.34 2.34 0 0 1-4.659 0 2.34 2.34 0 0 0-3.32-1.915 2.34 2.34 0 0 1-2.33-4.033 2.34 2.34 0 0 0 0-3.831A2.34 2.34 0 0 1 6.35 6.051a2.34 2.34 0 0 0 3.319-1.915",key:"1i5ecw"}],["circle",{cx:"12",cy:"12",r:"3",key:"1v7zrd"}]]),p=m("x",[["path",{d:"M18 6 6 18",key:"1bl5f8"}],["path",{d:"m6 6 12 12",key:"d8bk6v"}]]),g=m("upload",[["path",{d:"M12 3v12",key:"1x0j5s"}],["path",{d:"m17 8-5-5-5 5",key:"7q97r8"}],["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}]]);async function f(e,t){try{console.log("Calling /api/count-tokens with",e.length,"messages");let s=await fetch("/api/count-tokens",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({messages:e,apiKey:t})});if(console.log("API response status:",s.status),!s.ok){let e;let t=s.headers.get("content-type");if(t&&t.includes("text/html"))throw Error("API route not found (404). The server might need to restart.");try{e=(await s.json()).error||"API error: ".concat(s.status)}catch(a){let t=await s.text();e="API error: ".concat(s.status," - ").concat(t.slice(0,100))}throw Error(e)}let a=await s.json();return console.log("API response data:",a),a.input_tokens||0}catch(e){throw console.error("Error counting tokens:",e),e}}function j(e){return e.reduce((e,t)=>({text:e.text+t.tokens.text,images:e.images+t.tokens.images,total:e.total+t.tokens.total}),{text:0,images:0,total:0})}async function b(e,t){try{let s=await f(e,t);console.log("Total tokens from Anthropic API:",s);let a=e.map((e,t)=>(function(e,t){var s;let a=(s=e.content,null==s?[{type:"text",tokens:0,preview:"[empty]"}]:"string"==typeof s?[{type:"text",tokens:0,preview:(s||"").slice(0,100)}]:Array.isArray(s)?0===s.length?[{type:"text",tokens:0,preview:"[empty]"}]:s.map(e=>{if("text"in e)return{type:"text",tokens:0,preview:(e.text||"").slice(0,100)};if("reasoning"in e)return{type:"reasoning",tokens:0,preview:(e.reasoning||"").slice(0,100)};if("image"in e)return{type:"image",tokens:0,preview:"string"==typeof e.image?e.image.slice(0,50):"URL"};if("type"in e&&"file"===e.type&&"mediaType"in e)return{type:"file",tokens:0,preview:"".concat(e.filename||"file"," (").concat(e.mediaType,")"),imageUrl:e.url};if("type"in e&&"string"==typeof e.type&&e.type.startsWith("tool-")){let t;let s=e.type.replace("tool-","").split(/(?=[A-Z])/).join(" "),a=s;if("input"in e){let t=JSON.stringify(e.input);a="".concat(s,": ").concat(t.slice(0,50))}if("output"in e){if("string"==typeof e.output)a+=" → ".concat(e.output.slice(0,50));else if("object"==typeof e.output&&null!==e.output){if("image"===e.output.type&&e.output.data)t="data:image/jpeg;base64,".concat(e.output.data),a="".concat(s," → screenshot (").concat((e.output.data.length/1024).toFixed(1),"KB)");else{let t=JSON.stringify(e.output);a+=" → ".concat(t.slice(0,50))}}}return{type:"tool-call",tokens:0,preview:a,imageUrl:t}}return{type:"unknown",tokens:0,preview:JSON.stringify(e).slice(0,100)}}):[{type:"unknown",tokens:0,preview:JSON.stringify(s).slice(0,100)}]);return{messageIndex:t,role:e.role,tokens:{text:0,images:0,total:0},parts:a}})(e,t)),l=a.reduce((e,t)=>e+t.parts.length,0);if(0===l)return a;let n=s/l;return a.map(e=>{let t=e.parts.map(()=>Math.round(n)),s=t.reduce((e,t)=>e+t,0);return{...e,tokens:{text:s,images:0,total:s},parts:e.parts.map((e,s)=>({...e,tokens:t[s]}))}})}catch(e){throw console.error("API analysis failed:",e),e}}function v(e){let{analysis:t,zoom:s,onMessageClick:n}=e,r=Math.max(...t.map(e=>e.tokens.total),1),i={system:"#8b5cf6",user:"#3b82f6",assistant:"#10b981",tool:"#f59e0b"},o=(0,l.useMemo)(()=>t.map(e=>{let t=e.tokens.total/r;return{...e,intensity:t,height:Math.max(20,120*t*s)}}),[t,r,s]);return 0===t.length?null:(0,a.jsxs)("div",{className:"bg-[#1a1a1a] border border-[#2a2a2a] rounded-lg p-6",children:[(0,a.jsx)("div",{className:"text-sm font-medium mb-4",children:"Token Distribution Heatmap"}),(0,a.jsxs)("div",{className:"flex gap-2",children:[(0,a.jsxs)("div",{className:"flex flex-col justify-between text-[10px] text-[#666] pr-2 border-r border-[#2a2a2a] min-w-[40px] items-end",children:[(0,a.jsx)("div",{children:r.toLocaleString()}),(0,a.jsx)("div",{className:"transform -rotate-90 origin-center whitespace-nowrap py-2",children:"Tokens"}),(0,a.jsx)("div",{children:"0"})]}),(0,a.jsxs)("div",{className:"flex-1",children:[(0,a.jsx)("div",{className:"flex items-end gap-1 overflow-x-auto pb-2",style:{minHeight:"".concat(140*s,"px")},children:o.map((e,t)=>{let s=i[e.role]||"#888";return(0,a.jsxs)("div",{className:"relative group flex-shrink-0",style:{width:"".concat(Math.max(8,100/o.length),"px"),minWidth:"8px"},children:[(0,a.jsx)("div",{className:"rounded-sm transition-all hover:opacity-100 cursor-pointer",style:{height:"".concat(e.height,"px"),backgroundColor:s,opacity:.3+.7*e.intensity},onClick:()=>n(e.messageIndex)}),(0,a.jsx)("div",{className:"absolute bottom-full left-1/2 -translate-x-1/2 mb-2 hidden group-hover:block z-10",children:(0,a.jsxs)("div",{className:"bg-[#0a0a0a] border border-[#2a2a2a] rounded px-3 py-2 text-xs whitespace-nowrap shadow-lg",children:[(0,a.jsxs)("div",{className:"font-medium mb-1",children:["Message ",e.messageIndex]}),(0,a.jsx)("div",{className:"text-[#888]",children:e.role}),(0,a.jsxs)("div",{className:"font-semibold mt-1",children:[e.tokens.total.toLocaleString()," tokens"]}),e.tokens.images>0&&(0,a.jsxs)("div",{className:"text-[#888] text-[10px]",children:[e.tokens.images," media"]}),(0,a.jsx)("div",{className:"text-[#666] text-[10px] mt-1",children:"Click to view"})]})})]},t)})}),(0,a.jsxs)("div",{className:"flex items-center justify-between mt-2 text-xs text-[#666] border-t border-[#2a2a2a] pt-2",children:[(0,a.jsx)("div",{children:"Message 0"}),(0,a.jsx)("div",{className:"text-[10px]",children:"Message Index"}),(0,a.jsxs)("div",{children:["Message ",t.length-1]})]})]})]}),(0,a.jsx)("div",{className:"flex items-center gap-4 mt-4 flex-wrap",children:Object.entries(i).map(e=>{let[t,s]=e;return(0,a.jsxs)("div",{className:"flex items-center gap-2 text-xs",children:[(0,a.jsx)("div",{className:"w-3 h-3 rounded",style:{backgroundColor:s}}),(0,a.jsx)("span",{className:"text-[#888]",children:t})]},t)})})]})}let y=m("chevron-down",[["path",{d:"m6 9 6 6 6-6",key:"qrunsl"}]]),N=m("chevron-right",[["path",{d:"m9 18 6-6-6-6",key:"mthhwq"}]]),w=m("zap",[["path",{d:"M4 14a1 1 0 0 1-.78-1.63l9.9-10.2a.5.5 0 0 1 .86.46l-1.92 6.02A1 1 0 0 0 13 10h7a1 1 0 0 1 .78 1.63l-9.9 10.2a.5.5 0 0 1-.86-.46l1.92-6.02A1 1 0 0 0 11 14z",key:"1xq2db"}]]),k=e=>{let{base64Data:t}=e,[s,n]=(0,l.useState)(null),[r,i]=(0,l.useState)(!0);return((0,l.useEffect)(()=>{let e=new Image,s="data:image/jpeg;base64,".concat(t);e.onload=()=>{let s="JPEG";t.startsWith("/9j/")?s="JPEG":t.startsWith("iVBOR")?s="PNG":t.startsWith("R0lGOD")?s="GIF":t.startsWith("UklGR")&&(s="WebP"),n({width:e.width,height:e.height,fileType:s,sizeKB:parseFloat((.75*t.length/1024).toFixed(1))}),i(!1)},e.onerror=()=>{i(!1)},e.src=s},[t]),r)?(0,a.jsx)("div",{className:"text-xs text-[#666]",children:"Loading image..."}):s?(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsxs)("div",{className:"grid grid-cols-2 gap-2 text-xs",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("span",{className:"text-[#666]",children:"Resolution:"}),(0,a.jsxs)("span",{className:"text-[#aaa] ml-1",children:[s.width," \xd7 ",s.height]})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("span",{className:"text-[#666]",children:"Type:"}),(0,a.jsx)("span",{className:"text-[#aaa] ml-1",children:s.fileType})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("span",{className:"text-[#666]",children:"Size:"}),(0,a.jsxs)("span",{className:"text-[#aaa] ml-1",children:[s.sizeKB," KB"]})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("span",{className:"text-[#666]",children:"Pixels:"}),(0,a.jsx)("span",{className:"text-[#aaa] ml-1",children:(s.width*s.height).toLocaleString()})]})]}),(0,a.jsx)("img",{src:"data:image/jpeg;base64,".concat(t),alt:"Screenshot",className:"max-w-full h-auto rounded border border-[#2a2a2a]",style:{maxHeight:"400px"}})]}):(0,a.jsx)("div",{className:"text-xs text-[#666]",children:"Failed to load image"})};function S(e){let{messages:t,analysis:s,zoom:n,selectedMessageId:r,apiKey:i,onUpdateAnalysis:o}=e,[c,d]=(0,l.useState)(new Set),[x,m]=(0,l.useState)(new Set),[h,u]=(0,l.useState)(null);(0,l.useEffect)(()=>{null!==r&&d(e=>new Set(e).add(r))},[r]);let p=e=>{let t=new Set(c);t.has(e)?t.delete(e):t.add(e),d(t)},g=(e,t)=>{let s="".concat(e,"-").concat(t),a=new Set(x);a.has(s)?a.delete(s):a.add(s),m(a)},f=async e=>{if(i){u(e);try{let a=await fetch("/api/count-tokens",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({messages:[t[e]],apiKey:i})});if(!a.ok)throw Error("API call failed");let l=(await a.json()).input_tokens||0,n=t[e],r=n.content;if(Array.isArray(r)&&r.length>0){let t=await Promise.all(r.map(async e=>{try{let t={role:n.role,content:[e]},s=await fetch("/api/count-tokens",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({messages:[t],apiKey:i})});if(!s.ok)return 0;return(await s.json()).input_tokens||0}catch(e){return 0}})),a=s[e],c={...a,tokens:{text:l,images:0,total:l},parts:a.parts.map((e,s)=>({...e,tokens:t[s]||0}))};o(e,c)}}catch(e){console.error("Error calculating tokens:",e)}finally{u(null)}}},j={system:"#8b5cf6",user:"#3b82f6",assistant:"#10b981",tool:"#f59e0b"};return(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsx)("div",{className:"text-sm font-medium mb-3",children:"Messages"}),s.map(e=>{let s=t[e.messageIndex],l=c.has(e.messageIndex),n=r===e.messageIndex,i=j[e.role]||"#888";return(0,a.jsxs)("div",{id:"message-".concat(e.messageIndex),className:"bg-[#1a1a1a] border rounded-lg overflow-hidden transition-all ".concat(n?"border-[#4a4a4a] ring-2 ring-[#3a3a3a]":"border-[#2a2a2a]"),children:[(0,a.jsx)("button",{onClick:()=>p(e.messageIndex),className:"w-full px-4 py-3 flex items-center justify-between transition-colors text-left ".concat(n?"bg-[#252525]":"hover:bg-[#1f1f1f]"),children:(0,a.jsxs)("div",{className:"flex items-center gap-3 flex-1 min-w-0",children:[l?(0,a.jsx)(y,{size:16}):(0,a.jsx)(N,{size:16}),(0,a.jsx)("div",{className:"w-2 h-2 rounded-full flex-shrink-0",style:{backgroundColor:i}}),(0,a.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,a.jsxs)("span",{className:"font-medium",children:["Message ",e.messageIndex]}),(0,a.jsx)("span",{className:"text-[#888] ml-2",children:e.role})]}),(0,a.jsxs)("div",{className:"text-sm text-[#888] flex items-center gap-4 flex-shrink-0",children:[e.parts.length>1&&(0,a.jsxs)("span",{className:"text-xs",children:[e.parts.length," parts"]}),(0,a.jsxs)("span",{className:"font-medium",children:[e.tokens.total," tokens"]})]})]})}),l&&(0,a.jsxs)("div",{className:"px-4 pb-4 space-y-4",children:[(0,a.jsx)("button",{onClick:()=>f(e.messageIndex),disabled:h===e.messageIndex,className:"w-full py-2 px-3 bg-[#2a2a2a] hover:bg-[#3a3a3a] disabled:opacity-50 disabled:cursor-not-allowed rounded flex items-center justify-center gap-2 text-sm transition-colors",children:h===e.messageIndex?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white"}),(0,a.jsx)("span",{children:"Calculating accurate tokens..."})]}):(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(w,{size:14}),(0,a.jsx)("span",{children:"Calculate Accurate Token Breakdown"})]})}),(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsx)("div",{className:"text-xs text-[#888] font-medium",children:"Token Breakdown"}),e.parts.map((t,l)=>{let n=t.tokens/e.tokens.total*100,r="".concat(e.messageIndex,"-").concat(l),o=x.has(r),c="tool-call"===t.type,d=t.type;if(c){let e=s.content;if(Array.isArray(e)&&e[l]){var m;let t=e[l];(null===(m=t.type)||void 0===m?void 0:m.startsWith("tool-"))&&(d=t.type.replace("tool-","").replace(/([A-Z])/g," $1").trim())}}return(0,a.jsxs)("div",{className:"space-y-1",children:[(0,a.jsxs)("button",{onClick:()=>{c&&g(e.messageIndex,l)},className:"w-full flex items-center justify-between text-xs ".concat(c?"hover:bg-[#252525] rounded px-2 py-1 cursor-pointer":""),children:[(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)("span",{className:"text-[#aaa]",children:d}),c&&(o?(0,a.jsx)(y,{size:12}):(0,a.jsx)(N,{size:12}))]}),(0,a.jsxs)("span",{className:"text-[#888]",children:[t.tokens.toLocaleString()," tokens (",n.toFixed(1),"%)"]})]}),(0,a.jsx)("div",{className:"h-1.5 bg-[#0f0f0f] rounded-full overflow-hidden",children:(0,a.jsx)("div",{className:"h-full rounded-full transition-all",style:{width:"".concat(n,"%"),backgroundColor:i,opacity:.6}})}),c&&o&&(0,a.jsx)("div",{className:"mt-2 ml-4 p-3 bg-[#0f0f0f] rounded border border-[#2a2a2a]",children:(()=>{let e=s.content;if(Array.isArray(e)&&e[l]){var n,r;let t=e[l],s=(null===(n=t.type)||void 0===n?void 0:n.replace("tool-","").replace(/([A-Z])/g," $1").trim())||"Unknown Tool";return(0,a.jsxs)("div",{className:"space-y-3",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("div",{className:"text-xs text-[#666] mb-1",children:"Tool Name:"}),(0,a.jsx)("div",{className:"text-xs text-[#ddd] font-medium",children:s})]}),t.input&&(0,a.jsxs)("div",{children:[(0,a.jsx)("div",{className:"text-xs text-[#666] mb-1",children:"Input:"}),(0,a.jsx)("pre",{className:"text-xs text-[#999] whitespace-pre-wrap break-words font-mono p-2 bg-[#1a1a1a] rounded",children:JSON.stringify(t.input,null,2)})]}),t.output&&(0,a.jsxs)("div",{children:[(0,a.jsx)("div",{className:"text-xs text-[#666] mb-1",children:"Output:"}),"image"===t.output.type&&t.output.data?(0,a.jsx)(k,{base64Data:t.output.data}):(0,a.jsx)("pre",{className:"text-xs text-[#999] whitespace-pre-wrap break-words font-mono p-2 bg-[#1a1a1a] rounded max-h-[300px] overflow-y-auto",children:"string"==typeof t.output?t.output:JSON.stringify(t.output,null,2)})]}),t.state&&(0,a.jsxs)("div",{children:[(0,a.jsx)("div",{className:"text-xs text-[#666] mb-1",children:"State:"}),(0,a.jsx)("div",{className:"text-xs text-[#999]",children:t.state})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("div",{className:"text-xs text-[#666] mb-1",children:"Raw Tool Call Data (sent to Anthropic):"}),(0,a.jsx)("pre",{className:"text-xs text-[#999] whitespace-pre-wrap break-words font-mono p-2 bg-[#1a1a1a] rounded max-h-[400px] overflow-y-auto",children:JSON.stringify(t,(e,t)=>"data"===e&&"string"==typeof t&&t.length>100?t.substring(0,100)+"... [".concat(t.length," chars total, ").concat((.75*t.length/1024).toFixed(1),"KB]"):t,2)}),(0,a.jsxs)("div",{className:"text-xs text-[#666] mt-2",children:["Structure size: ",JSON.stringify(t).length.toLocaleString()," characters",(null===(r=t.output)||void 0===r?void 0:r.data)&&(0,a.jsxs)(a.Fragment,{children:[" • Base64 length: ",t.output.data.length.toLocaleString()," chars"]})]})]})]})}return(0,a.jsx)("div",{className:"text-xs text-[#999] whitespace-pre-wrap break-words font-mono",children:t.preview})})()})]},l)})]})]})]},e.messageIndex)})]})}function A(e){let{analysis:t}=e,s=j(t),l=t.reduce((e,t)=>(e[t.role]||(e[t.role]={text:0,images:0,total:0}),e[t.role].text+=t.tokens.text,e[t.role].images+=t.tokens.images,e[t.role].total+=t.tokens.total,e),{}),n={system:"#8b5cf6",user:"#3b82f6",assistant:"#10b981",tool:"#f59e0b"};return(0,a.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4",children:[(0,a.jsxs)("div",{className:"bg-[#1a1a1a] border border-[#2a2a2a] rounded-lg p-4",children:[(0,a.jsx)("div",{className:"text-sm text-[#888] mb-1",children:"Total Tokens"}),(0,a.jsx)("div",{className:"text-2xl font-semibold",children:s.total.toLocaleString()}),(0,a.jsxs)("div",{className:"text-xs text-[#666] mt-2",children:[s.text.toLocaleString()," text + ",s.images.toLocaleString()," media"]})]}),Object.entries(l).map(e=>{let[t,l]=e;return(0,a.jsxs)("div",{className:"bg-[#1a1a1a] border border-[#2a2a2a] rounded-lg p-4",children:[(0,a.jsxs)("div",{className:"text-sm text-[#888] mb-1 flex items-center gap-2",children:[(0,a.jsx)("div",{className:"w-2 h-2 rounded-full",style:{backgroundColor:n[t]||"#888"}}),t.charAt(0).toUpperCase()+t.slice(1)]}),(0,a.jsx)("div",{className:"text-2xl font-semibold",children:l.total.toLocaleString()}),(0,a.jsxs)("div",{className:"text-xs text-[#666] mt-2",children:[(l.total/s.total*100).toFixed(1),"% of total"]})]},t)})]})}function C(){let[e,t]=(0,l.useState)([]),[s,n]=(0,l.useState)(null),[r,i]=(0,l.useState)(""),[o,c]=(0,l.useState)("all"),[d,x]=(0,l.useState)(""),[m,f]=(0,l.useState)(!1),[y,N]=(0,l.useState)(1),[w,k]=(0,l.useState)(!1),[C,I]=(0,l.useState)(""),[T,P]=(0,l.useState)(null),[z,L]=(0,l.useState)(null),[M,O]=(0,l.useState)(!1),[F,E]=(0,l.useState)(null),[J,B]=(0,l.useState)(null);(0,l.useEffect)(()=>{let e=localStorage.getItem("anthropic-api-key");e&&x(e)},[]);let K=async e=>{var t;let s=null===(t=e.target.files)||void 0===t?void 0:t[0];if(!s||!d)return;O(!0),L(null),E(null),B(null);let a=new FileReader;a.onload=async e=>{try{var t,a,l;let n=(null===(t=e.target)||void 0===t?void 0:t.result).split(",")[1],r=s.type;E(null===(a=e.target)||void 0===a?void 0:a.result);let i=new Image;i.onload=async()=>{B({width:i.width,height:i.height,sizeKB:parseFloat((s.size/1024).toFixed(1)),base64Length:n.length});let e={messages:[{role:"user",content:[{type:"image",source:{type:"base64",media_type:r,data:n}}]}],apiKey:d};console.log("Image upload request:",{...e,messages:[{...e.messages[0],content:[{...e.messages[0].content[0],source:{...e.messages[0].content[0].source,data:"[".concat(n.length," chars]")}}]}]});let t=await fetch("/api/count-tokens",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!t.ok)throw Error("API call failed");let a=await t.json();console.log("Token count response:",a),L(a.input_tokens||0),O(!1)},i.src=null===(l=e.target)||void 0===l?void 0:l.result}catch(e){console.error("Error counting image tokens:",e),I("Failed to count image tokens"),O(!1)}},a.readAsDataURL(s)},R=(0,l.useCallback)(async e=>{var s;let a=null===(s=e.target.files)||void 0===s?void 0:s[0];if(!a)return;k(!0),I(""),n(null);let l=new FileReader;l.onload=async e=>{try{var s;let a;let l=JSON.parse(null===(s=e.target)||void 0===s?void 0:s.result);if(Array.isArray(l))a=l;else if(l.data&&l.data.messages&&Array.isArray(l.data.messages))a=l.data.messages;else if(l.messages&&Array.isArray(l.messages))a=l.messages;else{I('Invalid format. Expected array of messages, object with "messages" field, or object with "data.messages" field.'),k(!1);return}if(a=a.map(e=>e.parts&&!e.content?{...e,content:e.parts}:e),0===a.length){I("No messages found in the file."),k(!1);return}let n=new Map;a.forEach(e=>{let t=e.metadata,s=(null==t?void 0:t.chatId)||"default";n.has(s)||n.set(s,{messages:[],createdAt:(null==t?void 0:t.createdAt)||0});let a=n.get(s);a&&a.messages.push(e)});let r=[];if(!d){I("Anthropic API key required for accurate token counting. Please set your API key in settings."),k(!1);return}for(let[e,t]of n.entries()){let s=t.messages.sort((e,t)=>{let s=e.metadata,a=t.metadata;return((null==s?void 0:s.createdAt)||0)-((null==a?void 0:a.createdAt)||0)}),a=await b(s,d),l=j(a);r.push({chatId:e,messages:s,analysis:a,createdAt:t.createdAt,messageCount:s.length,totalTokens:l.total})}r.sort((e,t)=>t.createdAt-e.createdAt),t(r),k(!1)}catch(e){I("Failed to parse JSON: "+e.message),k(!1)}},l.onerror=()=>{I("Failed to read file"),k(!1)},l.readAsText(a)},[d]),U=s?s.analysis.filter(e=>{let t="all"===o||e.role===o,s=""===r||e.parts.some(e=>{var t;return null===(t=e.preview)||void 0===t?void 0:t.toLowerCase().includes(r.toLowerCase())});return t&&s}):[],W=e.reduce((e,t)=>e+t.totalTokens,0);return(0,a.jsxs)("div",{className:"min-h-screen bg-[#0a0a0a] text-white",children:[(0,a.jsx)("div",{className:"border-b border-[#1a1a1a] bg-[#0f0f0f]",children:(0,a.jsxs)("div",{className:"max-w-[1800px] mx-auto px-6 py-4 flex items-center justify-between",children:[(0,a.jsxs)("div",{className:"flex items-center gap-4",children:[s&&(0,a.jsx)("button",{onClick:()=>n(null),className:"p-2 hover:bg-[#1a1a1a] rounded-md transition-colors",children:(0,a.jsx)(h,{size:18})}),(0,a.jsx)("h1",{className:"text-lg font-semibold",children:"AI SDK Token Analyzer"}),s&&(0,a.jsxs)("div",{className:"text-sm text-[#888]",children:[s.messageCount," messages • ",s.totalTokens.toLocaleString()," tokens"]}),!s&&e.length>0&&(0,a.jsxs)("div",{className:"text-sm text-[#888]",children:[e.length," chats • ",W.toLocaleString()," total tokens"]})]}),(0,a.jsx)("button",{onClick:()=>f(!0),className:"p-2 hover:bg-[#1a1a1a] rounded-md transition-colors",children:(0,a.jsx)(u,{size:18})})]})}),(0,a.jsxs)("div",{className:"max-w-[1800px] mx-auto px-6 py-6",children:[!d&&(0,a.jsxs)("div",{className:"mb-4 p-4 bg-red-900/20 border border-red-500/50 rounded-lg text-red-200",children:[(0,a.jsx)("div",{className:"font-medium mb-1",children:"⚠️ API Key Required"}),(0,a.jsx)("div",{className:"text-sm",children:"Set your Anthropic API key in settings to get accurate token counts from Claude Sonnet 4.5. Without it, token counts cannot be calculated."})]}),C&&(0,a.jsxs)("div",{className:"mb-4 p-4 bg-red-900/20 border border-red-500/50 rounded-lg text-red-200 flex items-center justify-between",children:[(0,a.jsx)("span",{children:C}),(0,a.jsx)("button",{onClick:()=>I(""),className:"ml-4 p-1 hover:bg-red-800/30 rounded transition-colors",children:(0,a.jsx)(p,{size:18})})]}),0===e.length?(0,a.jsxs)("div",{className:"space-y-6",children:[d&&(0,a.jsx)("div",{className:"max-w-2xl mx-auto",children:(0,a.jsxs)("div",{className:"bg-[#1a1a1a] border border-[#2a2a2a] rounded-lg p-6",children:[(0,a.jsx)("h3",{className:"text-lg font-medium mb-4",children:"Image Token Counter"}),(0,a.jsx)("p",{className:"text-sm text-[#888] mb-4",children:"Upload an image to see how many tokens it uses"}),(0,a.jsxs)("label",{className:"cursor-pointer block",children:[(0,a.jsx)("input",{type:"file",accept:"image/*",onChange:K,className:"hidden",disabled:M}),(0,a.jsx)("div",{className:"border-2 border-dashed border-[#2a2a2a] rounded-lg p-6 hover:border-[#3a3a3a] transition-colors text-center",children:M?(0,a.jsxs)("div",{className:"flex flex-col items-center gap-2",children:[(0,a.jsx)("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-white"}),(0,a.jsx)("span",{className:"text-sm text-[#888]",children:"Counting tokens..."})]}):(0,a.jsx)("div",{className:"text-sm text-[#888]",children:"Click to upload image"})})]}),F&&null!==z&&(0,a.jsxs)("div",{className:"mt-4 space-y-3",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between p-3 bg-[#0f0f0f] rounded",children:[(0,a.jsx)("span",{className:"text-sm text-[#888]",children:"Token Count (from Anthropic API):"}),(0,a.jsx)("span",{className:"text-lg font-semibold text-white",children:z.toLocaleString()})]}),J&&(0,a.jsxs)("div",{className:"grid grid-cols-2 gap-2 p-3 bg-[#0f0f0f] rounded text-xs",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("span",{className:"text-[#666]",children:"Resolution:"}),(0,a.jsxs)("span",{className:"text-[#aaa] ml-1",children:[J.width," \xd7 ",J.height]})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("span",{className:"text-[#666]",children:"File Size:"}),(0,a.jsxs)("span",{className:"text-[#aaa] ml-1",children:[J.sizeKB," KB"]})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("span",{className:"text-[#666]",children:"Pixels:"}),(0,a.jsx)("span",{className:"text-[#aaa] ml-1",children:(J.width*J.height).toLocaleString()})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("span",{className:"text-[#666]",children:"Base64 Length:"}),(0,a.jsx)("span",{className:"text-[#aaa] ml-1",children:J.base64Length.toLocaleString()})]})]}),(0,a.jsx)("img",{src:F,alt:"Uploaded",className:"max-w-full h-auto rounded border border-[#2a2a2a]",style:{maxHeight:"300px"}})]})]})}),(0,a.jsx)("div",{className:"flex items-center justify-center",children:(0,a.jsxs)("label",{className:"cursor-pointer",children:[(0,a.jsx)("input",{type:"file",accept:".json",onChange:R,className:"hidden",disabled:w}),(0,a.jsx)("div",{className:"flex flex-col items-center gap-4 p-12 border-2 border-dashed border-[#2a2a2a] rounded-lg hover:border-[#3a3a3a] transition-colors",children:w?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-white"}),(0,a.jsx)("div",{className:"text-center",children:(0,a.jsx)("div",{className:"text-lg font-medium mb-1",children:"Processing file..."})})]}):(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(g,{size:48,className:"text-[#666]"}),(0,a.jsxs)("div",{className:"text-center",children:[(0,a.jsx)("div",{className:"text-lg font-medium mb-1",children:"Upload AI SDK Messages"}),(0,a.jsx)("div",{className:"text-sm text-[#888]",children:'JSON array or object with "messages" or "data.messages" field'})]})]})})]})})]}):s?(0,a.jsxs)("div",{className:"space-y-6",children:[(0,a.jsxs)("div",{className:"flex items-center gap-4 flex-wrap",children:[(0,a.jsx)("input",{type:"text",placeholder:"Search messages...",value:r,onChange:e=>i(e.target.value),className:"px-4 py-2 bg-[#1a1a1a] border border-[#2a2a2a] rounded-md focus:outline-none focus:border-[#3a3a3a] flex-1 min-w-[200px]"}),(0,a.jsxs)("select",{value:o,onChange:e=>c(e.target.value),className:"px-4 py-2 bg-[#1a1a1a] border border-[#2a2a2a] rounded-md focus:outline-none focus:border-[#3a3a3a]",children:[(0,a.jsx)("option",{value:"all",children:"All Roles"}),(0,a.jsx)("option",{value:"system",children:"System"}),(0,a.jsx)("option",{value:"user",children:"User"}),(0,a.jsx)("option",{value:"assistant",children:"Assistant"}),(0,a.jsx)("option",{value:"tool",children:"Tool"})]}),(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)("button",{onClick:()=>N(Math.max(.5,y-.1)),className:"px-3 py-2 bg-[#1a1a1a] border border-[#2a2a2a] rounded-md hover:bg-[#252525] transition-colors",children:"-"}),(0,a.jsxs)("span",{className:"text-sm text-[#888] w-12 text-center",children:[Math.round(100*y),"%"]}),(0,a.jsx)("button",{onClick:()=>N(Math.min(2,y+.1)),className:"px-3 py-2 bg-[#1a1a1a] border border-[#2a2a2a] rounded-md hover:bg-[#252525] transition-colors",children:"+"})]})]}),(0,a.jsx)(A,{analysis:s.analysis}),(0,a.jsx)(v,{analysis:U,zoom:y,onMessageClick:e=>{P(e);let t=document.getElementById("message-".concat(e));t&&t.scrollIntoView({behavior:"smooth",block:"center"})}}),(0,a.jsx)(S,{messages:s.messages,analysis:U,zoom:y,selectedMessageId:T,apiKey:d,onUpdateAnalysis:(a,l)=>{if(s){let r=[...s.analysis];r[a]=l;let i=j(r),o={...s,analysis:r,totalTokens:i.total};n(o),t(e.map(e=>e.chatId===s.chatId?o:e))}}})]}):(0,a.jsxs)("div",{className:"space-y-6",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsx)("h2",{className:"text-sm font-medium",children:"Chats"}),(0,a.jsxs)("label",{className:"cursor-pointer",children:[(0,a.jsx)("input",{type:"file",accept:".json",onChange:R,className:"hidden"}),(0,a.jsx)("div",{className:"px-4 py-2 bg-[#1a1a1a] border border-[#2a2a2a] rounded-md hover:bg-[#252525] transition-colors text-sm",children:"New File"})]})]}),(0,a.jsx)("div",{className:"grid gap-4",children:e.map(e=>{let t=(()=>{let t=e.messages.find(e=>"user"===e.role);if(!t)return null;if("string"==typeof t.content)return t.content.slice(0,120);if(Array.isArray(t.content)){let e=t.content.find(e=>"text"===e.type);if(e&&"text"in e)return e.text.slice(0,120)}return null})();return(0,a.jsxs)("button",{onClick:()=>n(e),className:"bg-[#1a1a1a] border border-[#2a2a2a] rounded-lg p-5 hover:border-[#3a3a3a] hover:bg-[#1f1f1f] transition-all text-left",children:[(0,a.jsxs)("div",{className:"flex items-start justify-between gap-4 mb-3",children:[(0,a.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,a.jsxs)("div",{className:"flex items-baseline gap-3 mb-2",children:[(0,a.jsx)("h3",{className:"font-medium text-white text-sm truncate",children:e.chatId}),(0,a.jsx)("span",{className:"text-xs text-[#999] whitespace-nowrap",children:(e=>{let t=Date.now()-e,s=Math.floor(t/6e4),a=Math.floor(t/36e5),l=Math.floor(t/864e5);return s<1?"just now":s<60?"".concat(s,"m ago"):a<24?"".concat(a,"h ago"):l<7?"".concat(l,"d ago"):new Date(e).toLocaleDateString()})(e.createdAt)})]}),t&&(0,a.jsx)("p",{className:"text-sm text-[#888] line-clamp-2 leading-relaxed",children:t})]}),(0,a.jsxs)("div",{className:"text-right flex-shrink-0",children:[(0,a.jsx)("div",{className:"text-3xl font-bold text-white mb-0.5",children:e.totalTokens>=1e3?"".concat((e.totalTokens/1e3).toFixed(1),"K"):e.totalTokens}),(0,a.jsx)("div",{className:"text-xs text-[#666] uppercase tracking-wider",children:"tokens"})]})]}),(0,a.jsxs)("div",{className:"flex items-center gap-4 text-xs text-[#666]",children:[(0,a.jsxs)("span",{children:[e.messageCount," messages"]}),(0,a.jsx)("span",{children:"•"}),(0,a.jsxs)("span",{children:[Math.round(e.totalTokens/e.messageCount)," avg"]})]})]},e.chatId)})})]})]}),m&&(0,a.jsx)("div",{className:"fixed inset-0 bg-black/80 flex items-center justify-center z-50",children:(0,a.jsxs)("div",{className:"bg-[#1a1a1a] border border-[#2a2a2a] rounded-lg p-6 w-full max-w-md",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between mb-4",children:[(0,a.jsx)("h2",{className:"text-lg font-semibold",children:"Settings"}),(0,a.jsx)("button",{onClick:()=>f(!1),className:"p-1 hover:bg-[#252525] rounded transition-colors",children:(0,a.jsx)(p,{size:18})})]}),(0,a.jsxs)("div",{className:"space-y-4",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm text-[#888] mb-2",children:"Anthropic API Key"}),(0,a.jsx)("input",{type:"password",value:d,onChange:e=>x(e.target.value),placeholder:"sk-ant-...",className:"w-full px-4 py-2 bg-[#0f0f0f] border border-[#2a2a2a] rounded-md focus:outline-none focus:border-[#3a3a3a]"}),(0,a.jsx)("div",{className:"text-xs text-[#666] mt-2",children:"Stored locally in your browser"})]}),(0,a.jsx)("button",{onClick:()=>{localStorage.setItem("anthropic-api-key",d),f(!1)},className:"w-full px-4 py-2 bg-[#2a2a2a] hover:bg-[#333] rounded-md transition-colors",children:"Save"})]})]})})]})}}},function(e){e.O(0,[684,651,744],function(){return e(e.s=6221)}),_N_E=e.O()}]);